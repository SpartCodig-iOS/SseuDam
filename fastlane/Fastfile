# Fastlane ê¸°ë³¸ ì„¤ì •
update_fastlane
default_platform(:ios)

ENV["FASTLANE_XCODEBUILD_SETTINGS_TIMEOUT"] = "600"

# ì•± ê´€ë ¨ ë³€ìˆ˜
APP_NAME = "SseuDamApp"
SCHEME = "SseuDamApp"
STAGE_SCHEME = "SseuDamApp"
BUNDLE_ID = "io.sseudam.co"
OUTPUT_DIR = "./fastlane/output"
IPA_FILENAME = "#{APP_NAME}.ipa"
TEAMID = ENV["TEAM_ID"]

# ë¦´ë¦¬ìŠ¤ìš© ë³€ìˆ˜ (ëˆ„ë½ë˜ì–´ ìˆë˜ ë¶€ë¶„ ë³´ì™„)
APP_RELEASE_NAME = APP_NAME
APP_RELEASE_SCHEME = SCHEME

APP_STAGE_NAME = STAGE_SCHEME
APP_STAGE_SCHEME = STAGE_SCHEME

platform :ios do


  # ğŸ“¦ Debug ë¹Œë“œ + ì •ë¦¬
  desc "Build Debug IPA and clean ._Symbols"
  lane :build_ipa_debug_and_strip do
    clear_derived_data
    # cleanup_output_folder
    match(type: "appstore", readonly: true)

     build_app(
      workspace: "#{APP_NAME}.xcworkspace",
      scheme: APP_RELEASE_NAME,
      output_directory: OUTPUT_DIR,
      output_name: IPA_FILENAME,
      export_method: "app-store",
      clean: true,
      silent: false, # ë””ë²„ê¹…ìš© false
      verbose: true,
      export_options: {
        signingStyle: "manual",
        uploadBitcode: false,
        provisioningProfiles: {
          "#{BUNDLE_ID}" => "match AppStore #{BUNDLE_ID}"
        }
      }
    )

  end

  # ğŸ“¦ Release ë¹Œë“œ + ì •ë¦¬
  desc "Build Release IPA and clean ._Symbols"
  lane :build_ipa_release_and_strip do
    clear_derived_data
    match(type: "appstore", readonly: true)

    build_app(
      workspace: "#{APP_RELEASE_NAME}.xcworkspace",
      scheme: "#{APP_RELEASE_SCHEME}",
      output_directory: OUTPUT_DIR,
      output_name: IPA_FILENAME,
      export_method: "app-store",
      clean: true,
      silent: false,
      verbose: true,
      export_options: {
        signingStyle: "manual",
        uploadBitcode: false,
        provisioningProfiles: {
          "#{BUNDLE_ID}" => "match AppStore #{BUNDLE_ID}"
        }
      }
    )

    # clean_symbols_from_ipa(ipa_path: ipa_path)
  end

  # ğŸš€ TestFlight ì—…ë¡œë“œ (Debug)
  desc "Upload to TestFlight (Debug)"
  lane :QA do
    app_store_connect_api_key(is_key_content_base64: true, in_house: false)
    match(type: "appstore", readonly: true)

    ipa_path = build_app(
      workspace: "#{APP_NAME}.xcworkspace",
      scheme: "#{APP_STAGE_SCHEME}",
      output_directory: OUTPUT_DIR,
      output_name: IPA_FILENAME,
      export_method: "app-store",
      clean: true,
      silent: false,
      verbose: true,
      export_options: {
        signingStyle: "manual",
        uploadBitcode: false,
        provisioningProfiles: {
          "#{BUNDLE_ID}" => "match AppStore #{BUNDLE_ID}"
        }
      }
    )

    upload_to_testflight(
      ipa: ipa_path,
      changelog: "ë³€ê²½ì‚¬í•­",
      groups: ["DDD", "ddd"],
      beta_app_description: "DDD ì¶œì„ ì•±ì…ë‹ˆë‹¤.",
      notify_external_testers: true,
      skip_waiting_for_build_processing: true
    )
  end

  # ğŸš€ App Store ë°°í¬
  desc "Submit to App Store"
  lane :release do |options|
    if options[:version]
      app_store_connect_api_key(is_key_content_base64: true, in_house: false)
      match(type: "appstore", readonly: true)

      ipa_path = build_app(
        workspace: "#{APP_RELEASE_NAME}.xcworkspace",
        scheme: "#{APP_RELEASE_SCHEME}",
        output_directory: OUTPUT_DIR,
        output_name: IPA_FILENAME,
        export_method: "app-store",
        clean: true,
        silent: false,
        verbose: true,
        export_options: {
          signingStyle: "manual",
          uploadBitcode: false,
          provisioningProfiles: {
            "#{BUNDLE_ID}" => "match AppStore #{BUNDLE_ID}"
          }
        }
      )

      # clean_symbols_from_ipa(ipa_path: ipa_path)

      upload_to_app_store(
        app_version: options[:version],
        username: "shuwj81@daum.net",
        team_id: "KL4Y9PB9B8",
        ipa: ipa_path,
        skip_metadata: false,
        metadata_path: "./fastlane/metadata",
        skip_screenshots: true,
        force: true,
        submit_for_review: true,
        automatic_release: false,
        precheck_include_in_app_purchases: false,
        submission_information: {
          add_id_info_uses_idfa: false,
          export_compliance_encryption_updated: false,
          export_compliance_uses_encryption: false,
          content_rights_contains_third_party_content: false
        }
      )
    else
      UI.user_error!("âš ï¸ version ì˜µì…˜ì„ ì§€ì •í•´ì£¼ì„¸ìš”: fastlane submit version:'1.0.0'")
    end
  end
end
