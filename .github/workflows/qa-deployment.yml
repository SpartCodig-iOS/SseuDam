name: QA Deployment

on:
  pull_request:
    types: [opened, synchronize, edited, labeled]
    branches: ['*'] # ëª¨ë“  ë¸Œëžœì¹˜ì—ì„œ PR ê°€ëŠ¥
  push:
    branches: ['*'] # ëª¨ë“  ë¸Œëžœì¹˜ì—ì„œ push ê°€ëŠ¥ (QA íƒœê·¸ ìžˆì„ ë•Œë§Œ ì‹¤í–‰)

jobs:
  check-qa-trigger:
    runs-on: ubuntu-latest
    outputs:
      should-deploy: ${{ steps.check.outputs.should-deploy }}
    steps:
      - name: Check QA trigger
        id: check
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # PR titleì´ë‚˜ bodyì— [QA], [qa], qa: íƒœê·¸ê°€ ìžˆëŠ”ì§€ í™•ì¸
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"

            if [[ "$PR_TITLE" =~ \[QA\]|\[qa\]|qa: ]] || [[ "$PR_BODY" =~ \[QA\]|\[qa\]|qa: ]]; then
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… QA tag found in PR title or body"
            else
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "âŒ QA tag not found"
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            # ì»¤ë°‹ ë©”ì‹œì§€ì— [QA], [qa], qa: íƒœê·¸ê°€ ìžˆëŠ”ì§€ í™•ì¸
            COMMIT_MESSAGE="${{ github.event.head_commit.message }}"

            if [[ "$COMMIT_MESSAGE" =~ \[QA\]|\[qa\]|qa: ]]; then
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "âœ… QA tag found in commit message: $COMMIT_MESSAGE"
            else
              echo "should-deploy=false" >> $GITHUB_OUTPUT
              echo "âŒ No QA tag in commit message"
            fi
          else
            echo "should-deploy=false" >> $GITHUB_OUTPUT
          fi

  qa-deployment:
    needs: check-qa-trigger
    if: needs.check-qa-trigger.outputs.should-deploy == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '15.4' # í”„ë¡œì íŠ¸ì— ë§žëŠ” Xcode ë²„ì „ìœ¼ë¡œ ë³€ê²½

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.0'
          bundler-cache: true

      - name: Cache Tuist
        uses: actions/cache@v4
        with:
          path: |
            ~/.tuist
            .build
          key: ${{ runner.os }}-tuist-${{ hashFiles('**/Project.swift', '**/Tuist/**') }}
          restore-keys: |
            ${{ runner.os }}-tuist-

      - name: Install Tuist
        run: |
          curl -Ls https://install.tuist.io | bash
          echo "$HOME/.tuist/bin" >> $GITHUB_PATH

      - name: Generate Xcode project
        run: |
          tuist install
          tuist generate

      - name: Cache CocoaPods
        uses: actions/cache@v4
        with:
          path: Pods
          key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: Install CocoaPods dependencies (if needed)
        run: |
          if [ -f "Podfile" ]; then
            pod install --repo-update
          fi

      - name: Create fastlane .env file from GitHub Secrets
        run: |
          # GitHub Secretsì—ì„œ fastlane/.env íŒŒì¼ ìƒì„±
          mkdir -p fastlane
          cat > fastlane/.env << EOF
          APP_IDENTIFIER="${{ secrets.APP_IDENTIFIER }}"
          APPLE_ID="${{ secrets.APPLE_ID }}"
          FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD="${{ secrets.FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD }}"
          TEAM_ID=${{ secrets.TEAM_ID }}
          APP_STORE_CONNECT_API_KEY_KEY_ID=${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
          APP_STORE_CONNECT_API_KEY_ISSUER_ID=${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY_KEY=${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
          EOF

          echo "âœ… fastlane/.env íŒŒì¼ ìƒì„± ì™„ë£Œ!"

      - name: Setup iOS certificates and provisioning profiles
        run: |
          # Fastlane matchë¥¼ ì‚¬ìš©í•œë‹¤ë©´ keychain ì„¤ì •
          security create-keychain -p "" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain

      - name: Run Fastlane QA
        run: |
          # fastlane/.env íŒŒì¼ ì‚¬ìš©í•˜ë¯€ë¡œ ë³„ë„ í™˜ê²½ë³€ìˆ˜ ì„¤ì • ë¶ˆí•„ìš”
          bundle exec fastlane QA

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qa-build-artifacts
          path: |
            *.ipa
            *.app.dSYM.zip
            fastlane/reports/
          retention-days: 30

      - name: Comment PR with QA build info
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            let buildStatus = '${{ job.status }}' === 'success' ? 'âœ… ì„±ê³µ' : 'âŒ ì‹¤íŒ¨';
            let buildNumber = process.env.BUILD_NUMBER || 'Unknown';

            const comment = `
            ## ðŸš€ QA ë¹Œë“œ ê²°ê³¼

            **ìƒíƒœ**: ${buildStatus}
            **ë¹Œë“œ ë²ˆí˜¸**: ${buildNumber}
            **ì»¤ë°‹**: ${context.sha.substring(0, 7)}

            ${buildStatus === 'âœ… ì„±ê³µ' ?
              'âœ… TestFlightì— ì—…ë¡œë“œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nðŸ“± TestFlight ì•±ì—ì„œ í™•ì¸ ê°€ëŠ¥í•©ë‹ˆë‹¤.' :
              'âŒ ë¹Œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.'}

            **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });


  notify-skip:
    needs: check-qa-trigger
    if: needs.check-qa-trigger.outputs.should-deploy == 'false' && github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Comment PR about skipping QA
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `
            ## â­ï¸ QA ë¹Œë“œ ìŠ¤í‚µ

            QA ë¹Œë“œë¥¼ ì‹¤í–‰í•˜ë ¤ë©´ PR ì œëª©ì´ë‚˜ ì„¤ëª…ì— ë‹¤ìŒ íƒœê·¸ ì¤‘ í•˜ë‚˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”:
            - \`[QA]\`
            - \`[qa]\`
            - \`qa:\`

            **ì˜ˆì‹œ**:
            - \`[QA] ìƒˆë¡œìš´ ì •ì‚° ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸\`
            - \`qa: ë²„ê·¸ ìˆ˜ì • í™•ì¸ í•„ìš”\`
            `;

            // ê¸°ì¡´ì— ìŠ¤í‚µ ì•Œë¦¼ì´ ìžˆìœ¼ë©´ ì‚­ì œí•˜ê³  ìƒˆë¡œ ì¶”ê°€
            const comments = await github.rest.issues.listComments({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
            });

            const existingComment = comments.data.find(
              comment => comment.body.includes('QA ë¹Œë“œ ìŠ¤í‚µ') && comment.user.type === 'Bot'
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                comment_id: existingComment.id,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }